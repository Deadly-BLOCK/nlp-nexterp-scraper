name: Scrape & Publish per-student

on:
  workflow_dispatch:
    inputs:
      student_code:
        description: 'Unique login code for the student'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Use a pre-built container that HAS chrome and node already
    container: mcr.microsoft.com/playwright:v1.41.0-jammy 

    steps:
      - name: ðŸ‘· Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install deps (Fast)
        # --no-audit and --preferred-offline skip network checks
        run: npm install --no-audit --no-fund --preferred-offline

      - name: ðŸ” Setup & Run
        env:
          CREDS_USR: ${{ secrets.CREDS_USR }}
          CREDS_PSSWD: ${{ secrets.CREDS_PSSWD }}
          STUDENT_CODE: ${{ github.event.inputs.student_code }}
        run: |
          # Fetch creds and run in one shell execution to save overhead
          curl -s -u "$CREDS_USR:$CREDS_PSSWD" https://rijash.com/nlp/creds.json > raw.json
          
          echo "USERNAME=$(jq -r --arg s "$STUDENT_CODE" '.[$s].username' raw.json)" > .env
          echo "PASSWORD=$(jq -r --arg s "$STUDENT_CODE" '.[$s].password' raw.json)" >> .env
          echo "CODE=$(jq -r --arg s "$STUDENT_CODE" '.[$s].code' raw.json)" >> .env
          
          node scrape.js "$STUDENT_CODE"

      - name: ðŸ’¾ Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "update ${{ github.event.inputs.student_code }}"
          file_pattern: "posts/*.json"
