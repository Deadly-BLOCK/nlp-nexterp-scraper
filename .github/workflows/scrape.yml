# .github/workflows/scrape.yml
name: Scrape & Publish per-student

on:
  workflow_dispatch:
    inputs:
      student_code:
        description: 'Unique login code for the student'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ‘· Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0            # ensure full history for committing

      - name: ğŸ” Fetch creds.json
        run: |
          curl -s -u bot:c29pbHN1cHBseWNhdHRsZXdlaWdodGlwbWludXRlbm9waHlzaWNhbGtub3dsZWRnZW0= https://rijash.com/nlp/creds.json -o creds.json
          echo "creds.json fetched"
          
      - name: ğŸ“ Populate .env
        run: |
          STUDENT="${{ github.event.inputs.student_code }}"
          USERNAME=$(jq -r --arg s "$STUDENT" '.[$s].username' creds.json)
          PASSWORD=$(jq -r --arg s "$STUDENT" '.[$s].password' creds.json)
          TWOFA=$(jq -r --arg s "$STUDENT" '.[$s].code'     creds.json)

          cat <<EOF > .env
          USERNAME=$USERNAME
          PASSWORD=$PASSWORD
          CODE=$TWOFA
          EOF

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¤– Run scraper
        env:
          STUDENT_CODE: ${{ github.event.inputs.student_code }}
        run: |
          node scrape.js "$STUDENT_CODE"

      - name: ğŸ’¾ Commit & push JSON
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update posts for ${{ github.event.inputs.student_code }} [skip ci]"
          file_pattern: "posts-${{ github.event.inputs.student_code }}.json"
          author_name: github-actions
          author_email: actions@github.com

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          keep_files: true
