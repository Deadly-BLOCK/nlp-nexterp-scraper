# .github/workflows/scrape.yml
name: Scrape & Publish per-student

on:
  workflow_dispatch:
    inputs:
      student_code:
        description: 'Unique login code for the student'
        required: true
  schedule:
    - cron: '*/10 * * * *'  # keep your schedule if you like

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ‘· Checkout
        uses: actions/checkout@v3

      - name: ğŸ” Fetch creds.json
        run: |
          curl -s "https://deadlyblock.com/scraping/nlp-scraper/creds.json" -o creds.json

      - name: ğŸ“ Populate .env
        run: |
          CODE="${{ github.event.inputs.student_code }}"
          USERNAME=$(jq -r --arg c "$CODE" '.[$c].username' creds.json)
          PASSWORD=$(jq -r --arg c "$CODE" '.[$c].password' creds.json)
          TWOFA=$(jq -r --arg c "$CODE" '.[$c].code'     creds.json)
          cat <<EOF > .env
          USERNAME=$USERNAME
          PASSWORD=$PASSWORD
          CODE=$TWOFA
          END
        env:
          PATH: /usr/bin:$PATH

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with: node-version: '20'

      - name: ğŸ“¦ Install deps
        run: npm ci

      - name: ğŸ¤– Run scraper
        run: |
          CODE="${{ github.event.inputs.student_code }}"
          node scrape.js "$CODE"

      - name: ğŸ’¾ Commit & push JSON
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update posts for ${{ github.event.inputs.student_code }} [skip ci]"
          file_pattern: "posts-${{ github.event.inputs.student_code }}.json"

      - name: ğŸš€ Deploy to GH-Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          keep_files: true
