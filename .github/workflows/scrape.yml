name: Scrape & Publish per-student

on:
  workflow_dispatch:
    inputs:
      student_code:
        description: 'Unique login code for the student'
        required: true

jobs:
  fast-scrape:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ‘· Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install Light Dependencies
        # Only installs axios and cookie support (approx 5MB vs Puppeteer's 200MB)
        run: npm install axios axios-cookiejar-support tough-cookie dotenv --no-save

      - name: ðŸ” Run
        env:
          CREDS_USR: ${{ secrets.CREDS_USR }}
          CREDS_PSSWD: ${{ secrets.CREDS_PSSWD }}
          STUDENT_CODE: ${{ github.event.inputs.student_code }}
        run: |
          # Fetch creds via jq
          curl -s -u "$CREDS_USR:$CREDS_PSSWD" https://rijash.com/nlp/creds.json > c.json
          echo "USERNAME=$(jq -r --arg s "$STUDENT_CODE" '.[$s].username' c.json)" > .env
          echo "PASSWORD=$(jq -r --arg s "$STUDENT_CODE" '.[$s].password' c.json)" >> .env
          echo "CODE=$(jq -r --arg s "$STUDENT_CODE" '.[$s].code' c.json)" >> .env
          
          node scrape.js "$STUDENT_CODE"

      - name: ðŸ’¾ Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "update posts for ${{ github.event.inputs.student_code }}"
          file_pattern: "posts/*.json"
