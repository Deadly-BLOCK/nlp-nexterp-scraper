# .github/workflows/scrape.yml
name: Scrape & Publish per-student

on:
  workflow_dispatch:
    inputs:
      student_code:
        description: 'Unique login code for the student'
        required: true
  schedule:
    - cron: '*/10 * * * *'  # keep your schedule if you like

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 👷 Checkout
        uses: actions/checkout@v3

      - name: 🔐 Fetch creds.json
        run: |
          curl -s "https://deadlyblock.com/scraping/nlp-scraper/creds.json" -o creds.json

      - name: 📝 Populate .env
        run: |
          CODE="${{ github.event.inputs.student_code }}"
          USERNAME=$(jq -r --arg c "$CODE" '.[$c].username' creds.json)
          PASSWORD=$(jq -r --arg c "$CODE" '.[$c].password' creds.json)
          TWOFA=$(jq -r --arg c "$CODE" '.[$c].code'     creds.json)
          cat <<EOF > .env
          USERNAME=$USERNAME
          PASSWORD=$PASSWORD
          CODE=$TWOFA
          END
        env:
          PATH: /usr/bin:$PATH

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v3
        with: node-version: '20'

      - name: 📦 Install deps
        run: npm ci

      - name: 🤖 Run scraper
        run: |
          CODE="${{ github.event.inputs.student_code }}"
          node scrape.js "$CODE"

      - name: 💾 Commit & push JSON
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update posts for ${{ github.event.inputs.student_code }} [skip ci]"
          file_pattern: "posts-${{ github.event.inputs.student_code }}.json"

      - name: 🚀 Deploy to GH-Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          keep_files: true
