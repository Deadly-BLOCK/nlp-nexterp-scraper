name: Scrape & Publish per-student

on:
  workflow_dispatch:
    inputs:
      student_code:
        description: 'Unique login code for the student'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš€ Fast Execution
        env:
          CREDS_USR: ${{ secrets.CREDS_USR }}
          CREDS_PSSWD: ${{ secrets.CREDS_PSSWD }}
          STUDENT_CODE: ${{ github.event.inputs.student_code }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Checkout (Manual git commands are faster than the checkout action)
          git clone --depth 1 https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git .
          
          # 2. Setup Env & Dependencies (Using pre-installed node/npm)
          # We use --no-save to keep the disk light
          npm install puppeteer dotenv --no-save --quiet
          
          # 3. Fetch Creds & Create .env (Single Pipe)
          curl -s -u "$CREDS_USR:$CREDS_PSSWD" https://rijash.com/nlp/creds.json > raw.json
          echo "USERNAME=$(jq -r --arg s "$STUDENT_CODE" '.[$s].username' raw.json)" > .env
          echo "PASSWORD=$(jq -r --arg s "$STUDENT_CODE" '.[$s].password' raw.json)" >> .env
          echo "CODE=$(jq -r --arg s "$STUDENT_CODE" '.[$s].code' raw.json)" >> .env
          
          # 4. Run Scraper
          node scrape.js "$STUDENT_CODE"
          
          # 5. Push changes manually (Much faster than the auto-commit action)
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add posts/
          git commit -m "chore: update $STUDENT_CODE" || exit 0
          git push origin main
