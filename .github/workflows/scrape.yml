name: Scrape & Publish per-student

on:
  workflow_dispatch:
    inputs:
      student_code:
        description: 'Unique login code for the student'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ‘· Checkout
        uses: actions/checkout@v4 # Upgraded to v4 for speed

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # This built-in cache saves ~20-30s on 'npm ci'

      - name: ðŸ“¦ Install dependencies
        # This only installs if the cache is missing
        run: npm ci

      - name: ðŸ” Fetch credentials
        env:
          CREDS_USR: ${{ secrets.CREDS_USR }}
          CREDS_PSSWD: ${{ secrets.CREDS_PSSWD }}
        run: |
          # Use curl directly to populate .env to avoid extra script steps
          curl -s -u "$CREDS_USR:$CREDS_PSSWD" https://rijash.com/nlp/creds.json > raw_creds.json
          
          STUDENT="${{ github.event.inputs.student_code }}"
          USERNAME=$(jq -r --arg s "$STUDENT" '.[$s].username' raw_creds.json)
          PASSWORD=$(jq -r --arg s "$STUDENT" '.[$s].password' raw_creds.json)
          TWOFA=$(jq -r --arg s "$STUDENT" '.[$s].code' raw_creds.json)

          echo "USERNAME=$USERNAME" > .env
          echo "PASSWORD=$PASSWORD" >> .env
          echo "CODE=$TWOFA" >> .env
          rm raw_creds.json

      - name: ðŸ¤– Run scraper
        env:
          STUDENT_CODE: ${{ github.event.inputs.student_code }}
        run: node scrape.js "$STUDENT_CODE"

      - name: ðŸ’¾ Commit & push JSON
        uses: stefanzweifel/git-auto-commit-action@v5 # Upgraded to v5
        with:
          commit_message: "chore: update posts for ${{ github.event.inputs.student_code }} [skip ci]"
          file_pattern: "posts/posts-${{ github.event.inputs.student_code }}.json"
          author_name: github-actions
          author_email: actions@github.com

      - name: ðŸš€ Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          keep_files: true
